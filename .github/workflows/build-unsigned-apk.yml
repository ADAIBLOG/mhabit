name: Build Unsigned APK

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.fvmrc'
  pull_request:
    branches:
      - main
      - master
      - develop
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.fvmrc'
  workflow_dispatch:

jobs:
  analyzing:
    uses: ./.github/workflows/_analyze.yml

  checking:
    uses: ./.github/workflows/_check.yml

  testing:
    uses: ./.github/workflows/_test.yml

  build-android:
    name: Build unsigned Android APK
    needs:
      - analyzing
      - checking
      - testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup_jdk
      - uses: ./.github/actions/setup_flutter
      - name: Build Debug APK (unsigned)
        id: build-debug
        run: |
          flutter build apk --debug --flavor f_dev --no-shrink --verbose
          DEBUG_APK_PATH="build/app/outputs/flutter-apk/app-f-dev-debug.apk"
          echo "path=$DEBUG_APK_PATH" >> "$GITHUB_OUTPUT"
          echo "Debug APK size: $(du -h $DEBUG_APK_PATH | cut -f1)"
        shell: bash
      - name: Build Release APK (unsigned)
        id: build-release
        run: |
          flutter build apk --release --flavor f_dev --no-shrink --verbose
          RELEASE_APK_PATH="build/app/outputs/flutter-apk/app-f-dev-release.apk"
          echo "path=$RELEASE_APK_PATH" >> "$GITHUB_OUTPUT"
          echo "Release APK size: $(du -h $RELEASE_APK_PATH | cut -f1)"
        shell: bash
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-android-apk
          path: |
            ${{ steps.build-debug.outputs.path }}
            ${{ steps.build-release.outputs.path }}
          retention-days: 30
