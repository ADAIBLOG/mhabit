name: Build Unsigned Android APK

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.fvmrc'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.fvmrc'
  workflow_dispatch:

jobs:
  build-unsigned-apk:
    name: Build Unsigned Android APK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java SDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          
      - name: Update Flutter submodule
        run: git submodule update --init --recursive
        shell: bash
        
      - name: Install Linux dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            curl git unzip xz-utils zip libglu1-mesa \
            clang cmake git \
            ninja-build pkg-config \
            libgtk-3-dev liblzma-dev \
            libstdc++-12-dev
        shell: bash
        
      - name: Add Flutter to syspath
        run: |
          echo "${{ github.workspace }}/.flutter/bin:$PATH" >> $GITHUB_PATH
        shell: bash
        
      - name: Get Flutter packages
        run: |
          echo $GITHUB_PATH
          flutter pub get
        shell: bash
        
      - name: Build Debug APK (Unsigned)
        run: |
          flutter build apk --debug --no-shrink
        shell: bash
        
      - name: Build Release APK (Unsigned)
        run: |
          flutter build apk --release --no-shrink
        shell: bash
        
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
          
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          
      - name: Get APK info
        id: apk-info
        run: |
          DEBUG_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
          RELEASE_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "debug-size=$DEBUG_SIZE" >> $GITHUB_OUTPUT
          echo "release-size=$RELEASE_SIZE" >> $GITHUB_OUTPUT
          echo "## APK Information" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debug | $DEBUG_SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | $RELEASE_SIZE |" >> $GITHUB_STEP_SUMMARY
        shell: bash
